<!DOCTYPE html>
<html lang="tl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Wikahusayan Quest</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .leaderboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .leaderboard-header h1 {
            color: #333;
            font-size: 36px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .leaderboard-header p {
            color: #666;
            font-size: 18px;
        }

        .leaderboard-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            max-width: 600px;
            margin: 0 auto 40px;
        }

        .tab-btn {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .leaderboard-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
            font-size: 16px;
        }

        .leaderboard-table td {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .leaderboard-table tr:hover td {
            background: rgba(102, 126, 234, 0.05);
        }

        .rank-cell {
            font-weight: bold;
            font-size: 20px;
            color: #333;
            width: 60px;
            text-align: center;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }

        .player-cell {
            display: flex;
            align-items: center;
        }

        .player-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .player-info h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .player-group {
            margin: 0;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .score-cell {
            font-weight: bold;
            font-size: 18px;
            color: #4CAF50;
            text-align: right;
        }

        .badges-cell {
            text-align: center;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
            background: #eee;
            color: #666;
        }

        .badge.gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .badge.silver { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; }
        .badge.bronze { background: linear-gradient(135deg, #CD7F32, #A0522D); color: white; }
        .badge.master { background: linear-gradient(135deg, #FF6B6B, #EE5A24); color: white; }
        .badge.champion { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .badge.gold\ scholar { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .badge.silver\ scholar { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; }
        .badge.bronze\ scholar { background: linear-gradient(135deg, #CD7F32, #A0522D); color: white; }
        .badge.quiz\ master { background: linear-gradient(135deg, #FF6B6B, #EE5A24); color: white; }
        .badge.quiz\ champion { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .badge.speed\ master { background: linear-gradient(135deg, #00BCD4, #009688); color: white; }
        .badge.speed\ champion { background: linear-gradient(135deg, #4CAF50, #388E3C); color: white; }
        .badge.matching\ master { background: linear-gradient(135deg, #FF9800, #F57C00); color: white; }
        .badge.matching\ champion { background: linear-gradient(135deg, #9C27B0, #7B1FA2); color: white; }

        .loading, .error, .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            font-style: italic;
        }

        .error {
            color: #f44336;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        @media (max-width: 768px) {
            .leaderboard-table th,
            .leaderboard-table td {
                padding: 12px 10px;
            }

            .player-avatar {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .player-info h4 {
                font-size: 14px;
            }

            .player-group {
                font-size: 12px;
            }

            .score-cell {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <a href="select.html" class="back-btn">‚Üê Bumalik sa Games</a>

    <div class="leaderboard-container">
        <div class="leaderboard-header">
            <h1>üèÜ Leaderboard</h1>
            <p>Overall Ranking combines Ladder Quiz + Speed Challenge + Drag & Drop scores. Individual tabs show game-specific rankings!</p>
        </div>

        <div class="leaderboard-tabs">
            <button class="tab-btn active" onclick="switchTab('overall')">Overall Ranking</button>
            <button class="tab-btn" onclick="switchTab('ladder')">Akyatin, Abutin at Mararating Natin! </button>
            <button class="tab-btn" onclick="switchTab('speed')">Buoin ko! Kaya Natin 'To</button>
            <button class="tab-btn" onclick="switchTab('matching')">Pabilisan? Kayang Lampasan!</button>
        </div>

        <div class="leaderboard-content">
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th style="width: 60px;">Rank</th>
                        <th>Player</th>
                        <th style="width: 120px; text-align: center;">Points</th>
                        <th style="width: 150px; text-align: center;">Badges</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <tr>
                        <td colspan="4" class="loading">Loading leaderboard...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, getDocs, query, orderBy, updateDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9khDPPquuztCUWLfzithwPmQFpI8t49g",
            authDomain: "wikahusayan-quest.firebaseapp.com",
            projectId: "wikahusayan-quest",
            storageBucket: "wikahusayan-quest.firebasestorage.app",
            messagingSenderId: "744849133114",
            appId: "1:744849133114:web:31c5f34bc1ace7e3a5ef03"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTab = 'overall';

        // Badge checking function
        function checkForNewBadges(totalPoints, existingBadges = []) {
            const newBadges = [];
            const badgeThresholds = [
                { points: 20, badge: 'Bronze Scholar' },
                { points: 50, badge: 'Silver Scholar' },
                { points: 100, badge: 'Gold Scholar' },
                { points: 200, badge: 'Platinum Scholar' },
                { points: 500, badge: 'Diamond Scholar' },
                { points: 1000, badge: 'Master Scholar' }
            ];

            badgeThresholds.forEach(({ points, badge }) => {
                if (totalPoints >= points && !existingBadges.includes(badge)) {
                    newBadges.push(badge);
                }
            });

            if (totalPoints >= 20 && !existingBadges.includes('First Steps')) {
                newBadges.push('First Steps');
            }

            if (totalPoints >= 100 && !existingBadges.includes('Knowledge Seeker')) {
                newBadges.push('Knowledge Seeker');
            }

            return newBadges;
        }

        // Migrate badges for existing players (one-time operation)
        async function migrateExistingBadges() {
            console.log('üîÑ Migrating badges for existing players...');
            try {
                const collections = [
                    { name: 'leaderboard_ladder', pointsField: 'points' },
                    { name: 'leaderboard_speed_challenge', pointsField: 'points' },
                    { name: 'leaderboard_drag_drop', pointsField: 'points' }
                ];

                for (const coll of collections) {
                    const ref = collection(db, coll.name);
                    const snap = await getDocs(ref);
                    console.log(`üìä ${coll.name}: found ${snap.docs.length} players`);

                    snap.forEach(async (doc) => {
                        const data = doc.data();
                        const points = data[coll.pointsField] || data.points || 0;
                        const existingBadges = data.badges || [];

                        // Check if this doc needs badge migration
                        if (!data.badges || data.badges.length === 0) {
                            const newBadges = checkForNewBadges(points, existingBadges);
                            const allBadges = [...existingBadges, ...newBadges];

                            if (allBadges.length > 0) {
                                await updateDoc(doc.ref, { badges: allBadges });
                                console.log(`‚úÖ ${coll.name} - ${data.displayName}: added badges:`, allBadges);
                            }
                        }
                    });
                }
                console.log('‚úÖ Badge migration complete!');
            } catch (error) {
                console.error('‚ùå Error migrating badges:', error);
            }
        }

        // Run migration once on page load
        migrateExistingBadges();

        // Load leaderboard immediately
        loadLeaderboard(currentTab);

        // Check authentication for highlighting current user
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            console.log('üîê Auth state changed:', user ? 'logged in' : 'anonymous');
            // Reload to update current user highlighting
            loadLeaderboard(currentTab);
        });

        // Switch between tabs
        window.switchTab = function(tabType) {
            currentTab = tabType;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadLeaderboard(tabType);
        };

        // Load leaderboard data
        async function loadLeaderboard(type) {
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading leaderboard...</td></tr>';

            try {
                let filteredDocs = [];

                if (type === 'overall') {
                    // Overall: Combine scores from all games
                    console.log('üìä Loading overall leaderboard - combining all game scores');

                    // Get ladder quiz scores
                    const ladderRef = collection(db, 'leaderboard_ladder');
                    const ladderSnapshot = await getDocs(ladderRef);
                    console.log('üìä Ladder quiz docs:', ladderSnapshot.docs.length);

                    // Get speed challenge scores
                    const speedRef = collection(db, 'leaderboard_speed_challenge');
                    const speedSnapshot = await getDocs(speedRef);
                    console.log('üìä Speed challenge docs:', speedSnapshot.docs.length);

                    // Get drag & drop scores
                    const matchingRef = collection(db, 'leaderboard_drag_drop');
                    const matchingSnapshot = await getDocs(matchingRef);
                    console.log('üìä Drag & drop docs:', matchingSnapshot.docs.length);

                    // Combine scores by user
                    const userScores = new Map();

                    // Add ladder scores
                    ladderSnapshot.forEach((doc) => {
                        const data = doc.data();
                        const userId = data.userId;
                        if (!userScores.has(userId)) {
                            userScores.set(userId, {
                                userId: userId,
                                displayName: data.displayName || 'Anonymous',
                                ladderPoints: 0,
                                speedPoints: 0,
                                matchingPoints: 0,
                                totalPoints: 0,
                                badges: []
                            });
                        }
                        const userData = userScores.get(userId);
                        userData.ladderPoints = data.points || 0;
                        userData.totalPoints += data.points || 0;
                        // Merge badges - avoid duplicates
                        if (data.badges && Array.isArray(data.badges)) {
                            userData.badges = [...new Set([...userData.badges, ...data.badges])];
                        }
                    });

                    // Add speed challenge scores
                    speedSnapshot.forEach((doc) => {
                        const data = doc.data();
                        const userId = data.userId;
                        if (!userScores.has(userId)) {
                            userScores.set(userId, {
                                userId: userId,
                                displayName: data.displayName || 'Anonymous',
                                ladderPoints: 0,
                                speedPoints: 0,
                                matchingPoints: 0,
                                totalPoints: 0,
                                badges: []
                            });
                        }
                        const userData = userScores.get(userId);
                        userData.speedPoints = data.points || 0;
                        userData.totalPoints += data.points || 0;
                        // Merge badges - avoid duplicates
                        if (data.badges && Array.isArray(data.badges)) {
                            userData.badges = [...new Set([...userData.badges, ...data.badges])];
                        }
                    });

                    // Add drag & drop scores
                    matchingSnapshot.forEach((doc) => {
                        const data = doc.data();
                        const userId = data.userId;
                        if (!userScores.has(userId)) {
                            userScores.set(userId, {
                                userId: userId,
                                displayName: data.displayName || 'Anonymous',
                                ladderPoints: 0,
                                speedPoints: 0,
                                matchingPoints: 0,
                                totalPoints: 0,
                                badges: []
                            });
                        }
                        const userData = userScores.get(userId);
                        userData.matchingPoints = data.points || 0;
                        userData.totalPoints += data.points || 0;
                        // Merge badges - avoid duplicates
                        if (data.badges && Array.isArray(data.badges)) {
                            userData.badges = [...new Set([...userData.badges, ...data.badges])];
                        }
                    });

                    // Convert to array and include all users
                    userScores.forEach((userData) => {
                        console.log(`üìä User ${userData.userId}: totalPoints=${userData.totalPoints}, ladder=${userData.ladderPoints}, speed=${userData.speedPoints}, matching=${userData.matchingPoints}`);
                        filteredDocs.push({
                            userId: userData.userId,
                            data: userData,
                            sortValue: userData.totalPoints
                        });
                    });

                    console.log(`üìä Overall leaderboard: ${filteredDocs.length} players with combined scores`);
                    console.log('üìä Overall userScores:', Array.from(userScores.entries()));

                } else {
                    // Individual game leaderboards
                    let collectionName;
                    if (type === 'ladder') {
                        collectionName = 'leaderboard_ladder';
                    } else if (type === 'speed') {
                        collectionName = 'leaderboard_speed_challenge';
                    } else if (type === 'matching') {
                        collectionName = 'leaderboard_drag_drop';
                    }

                    const gameRef = collection(db, collectionName);
                    const querySnapshot = await getDocs(gameRef);
                    console.log(`üìä ${type} collection docs:`, querySnapshot.docs.length);

                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        const points = data.points || 0;
                        console.log(`üìä ${type} doc:`, { 
                            id: doc.id, 
                            userId: data.userId, 
                            points, 
                            displayName: data.displayName,
                            badges: data.badges,
                            allData: data
                        });
                        filteredDocs.push({
                            doc,
                            data,
                            sortValue: points
                        });
                    });

                    console.log(`üìä ${type} filtered docs:`, filteredDocs.length);
                    console.log(`üìä ${type} all documents:`, filteredDocs.map(d => ({ userId: d.data.userId, displayName: d.data.displayName, badges: d.data.badges })));
                }

                tbody.innerHTML = '';

                // Sort by score descending
                filteredDocs.sort((a, b) => b.sortValue - a.sortValue);

                console.log(`üìä Final sorted ${type} docs:`, filteredDocs.map(d => ({ userId: d.data.userId || d.userId, points: d.sortValue, displayName: d.data.displayName })));

                let rank = 1;
                filteredDocs.forEach((item) => {
                    const data = item.data;
                    const userId = item.userId || (data && data.userId);
                    
                    const isCurrentUser = currentUser && (
                        (data && data.userId === currentUser.uid) ||
                        (userId && userId === currentUser.uid)
                    );

                    const row = document.createElement('tr');
                    if (isCurrentUser) {
                        row.style.background = 'rgba(102, 126, 234, 0.1)';
                        row.style.borderLeft = '4px solid #667eea';
                    }

                    const score = item.sortValue || data.totalPoints || data.points || 0;
                    const badges = (data.badges || []).filter(badge => badge !== 'Bronze Scholar');
                    console.log(`üìä Rendering rank ${rank}:`, { displayName: data.displayName, points: score, badges: badges, allBadges: data.badges, dataObj: data });

                    // For overall leaderboard, show breakdown
                    let scoreDisplay = `${score} pts`;
                    if (type === 'overall' && data.ladderPoints !== undefined && data.speedPoints !== undefined) {
                        scoreDisplay = `${score} pts (A:${data.ladderPoints} + P:${data.speedPoints})`;
                    }

                    // Create badge elements with proper class handling
                    const badgeHTML = badges.map(badge => {
                        // Convert badge name to CSS class (lowercase and keep spaces)
                        const badgeClass = badge.toLowerCase();
                        return `<span class="badge ${badgeClass}" title="${badge}">${badge}</span>`;
                    }).join('');

                    row.innerHTML = `
                        <td class="rank-cell rank-${rank <= 3 ? rank : ''}">#${rank}</td>
                        <td class="player-cell">
                            <div class="player-avatar">
                                ${(data.displayName || 'A').charAt(0).toUpperCase()}
                            </div>
                            <div class="player-info">
                                <h4>${data.displayName || 'Anonymous'} ${isCurrentUser ? '(You)' : ''}</h4>
                                <p class="player-group">${data.groupName || 'Individual Player'}</p>
                            </div>
                        </td>
                        <td class="score-cell">${scoreDisplay}</td>
                        <td class="badges-cell">
                            ${badgeHTML}
                        </td>
                    `;

                    tbody.appendChild(row);
                    rank++;
                });

                if (filteredDocs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="no-data">No scores available yet. Play some games to see rankings!</td></tr>';
                }

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                tbody.innerHTML = '<tr><td colspan="4" class="error">Error loading leaderboard. Please try again.</td></tr>';
            }
        }
    </script>
</body>
</html>