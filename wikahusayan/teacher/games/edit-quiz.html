<!DOCTYPE html>
<html lang="tl">
<head>
<meta charset="UTF-8">
<title>I-edit ang Speed Challenge - Wikahusayan Quest</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/teacher.css">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
}

.back-btn {
  position: fixed;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
  padding: 12px 20px;
  border-radius: 25px;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  z-index: 1000;
  backdrop-filter: blur(10px);
}

.back-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.edit-container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.edit-header {
  text-align: center;
  color: white;
  margin-bottom: 40px;
}

.edit-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.edit-subtitle {
  font-size: 1.2rem;
  color: rgba(255, 255, 255, 0.9);
}

.difficulty-tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 30px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  padding: 5px;
  backdrop-filter: blur(10px);
}

.difficulty-tab {
  padding: 12px 30px;
  border: none;
  background: transparent;
  color: rgba(255, 255, 255, 0.7);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.3s ease;
  flex: 1;
}

.difficulty-tab.active {
  background: white;
  color: #667eea;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.questions-container {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
}

.question-item {
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 15px;
  padding: 25px;
  margin-bottom: 20px;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  position: relative;
}

.question-item:hover {
  border-color: #667eea;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
}

.question-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.question-number {
  font-size: 1.1rem;
  font-weight: 700;
  color: #667eea;
}

.question-input {
  width: 100%;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  font-size: 1rem;
  margin-bottom: 15px;
  transition: border-color 0.3s ease;
}

.question-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.options-container {
  margin-left: 20px;
}

.option-item {
  display: flex;
  align-items: center;
  margin-bottom: 10px;
}

.correct-radio {
  margin-right: 10px;
  transform: scale(1.2);
}

.option-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 0.9rem;
  margin-left: 10px;
  transition: border-color 0.3s ease;
}

.option-input:focus {
  outline: none;
  border-color: #667eea;
}

.question-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.action-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.add-option-btn {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  color: white;
}

.add-option-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.delete-option-btn {
  background: linear-gradient(135deg, #f44336, #d32f2f);
  color: white;
}

.delete-option-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
}

.delete-question-btn {
  background: linear-gradient(135deg, #ff9800, #e68900);
  color: white;
  margin-left: auto;
}

.delete-question-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
}

.global-actions {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 30px;
  padding-top: 30px;
  border-top: 2px solid #e0e0e0;
}

.add-question-btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.add-question-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}

.save-btn {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  color: white;
  border: none;
  padding: 15px 30px;
  border-radius: 25px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
}

.save-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 12px 30px rgba(76, 175, 80, 0.4);
}

.save-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin-left: 10px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.status-message {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 25px;
  border-radius: 10px;
  color: white;
  font-weight: 600;
  z-index: 1000;
  animation: slideInRight 0.5s ease-out;
  backdrop-filter: blur(10px);
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.status-success {
  background: linear-gradient(135deg, #4CAF50, #45a049);
}

.status-error {
  background: linear-gradient(135deg, #f44336, #d32f2f);
}

.status-info {
  background: linear-gradient(135deg, #2196F3, #0b7dda);
}

/* Loading message styles */
.loading-message {
  text-align: center;
  padding: 60px 20px;
  color: white;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  margin: 0 auto 20px;
}

.loading-message p {
  font-size: 1.1rem;
  margin: 0;
}

/* Responsive design */
@media (max-width: 768px) {
  .edit-container {
    padding: 15px;
  }

  .edit-title {
    font-size: 2rem;
  }

  .difficulty-tabs {
    flex-direction: column;
  }

  .difficulty-tab {
    padding: 10px 20px;
  }

  .question-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }

  .question-actions {
    flex-direction: column;
  }

  .global-actions {
    flex-direction: column;
  }
}

.status-message {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  border-radius: 8px;
  color: white;
  font-weight: 600;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.status-success {
  background: #4CAF50;
}

.status-error {
  background: #f44336;
}

.option-item.correct-option {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  border-color: #28a745;
}

.option-label {
  background: #667eea;
  color: white;
  padding: 4px 8px;
  border-radius: 50%;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 10px;
}


.preview-btn:hover {
  background: #138496 !important;
}

.duplicate-btn:hover {
  background: #e0a800 !important;
}
</style>
</head>
<body>
<a href="edit-games.html" class="back-btn">üè† Bumalik sa Pili ng Laro</a>

<div class="edit-container">
  <div class="edit-header">
    <h1 class="edit-title">‚ö° I-edit ang Speed Challenge</h1>
    <p class="edit-subtitle">Mag-edit ng mga tanong para sa Timed Quiz</p>
  </div>

  <div id="loading-message" class="loading-message">
    <div class="loading-spinner"></div>
    <p>Sinusuri ang authentication...</p>
  </div>

  <div id="main-content" style="display: none;">
    <!-- Statistics Bar -->
    <div class="stats-bar" style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin-bottom: 30px; backdrop-filter: blur(10px);">
      <div style="display: flex; justify-content: space-around; text-align: center; color: white;">
        <div>
          <div style="font-size: 2rem; font-weight: 700;" id="easy-count">0</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Madali</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700;" id="medium-count">0</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Katamtaman</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700;" id="hard-count">0</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Mahirap</div>
        </div>
        <div>
          <div style="font-size: 2rem; font-weight: 700;" id="total-count">0</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">Kabuuang Tanong</div>
        </div>
      </div>
    </div>

    <div class="difficulty-tabs">
      <button class="difficulty-tab active" data-difficulty="easy">Madali</button>
      <button class="difficulty-tab" data-difficulty="medium">Katamtaman</button>
      <button class="difficulty-tab" data-difficulty="hard">Mahirap</button>
    </div>

    <div class="questions-container">
      <div id="questions-list">
        <!-- Questions will be loaded here -->
      </div>

      <div class="global-actions">
        <button class="add-question-btn" onclick="addQuestion()">
          ‚ûï Magdagdag ng Tanong
        </button>
        <button class="action-btn" onclick="resetToDefaults()" style="background: #dc3545; color: white;">
          üîÑ Reset to Defaults
        </button>
        <button class="action-btn" onclick="clearAllQuestions()" style="background: #ffc107; color: #000;">
          üóëÔ∏è Clear All
        </button>
        <button class="save-btn" id="save-btn">
          üíæ I-save ang Lahat
        </button>
      </div>
    </div>
  </div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
import { getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, query, where, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD9khDPPquuztCUWLfzithwPmQFpI8t49g",
  authDomain: "wikahusayan-quest.firebaseapp.com",
  projectId: "wikahusayan-quest",
  storageBucket: "wikahusayan-quest.firebasestorage.app",
  messagingSenderId: "744849133114",
  appId: "1:744849133114:web:31c5f34bc1ace7e3a5ef03"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Game state
let currentDifficulty = 'easy';
let currentUser = null;
let isAuthenticated = false;
let questionsData = {
  easy: [],
  medium: [],
  hard: []
};

// Default questions for each difficulty
const defaultQuestions = {
  easy: [
    {
      question: "Ano ang tamang salita para sa 'bahay'?",
      options: ["Pangngalan", "Pang-uri", "Pandiwang", "Pang-abay"],
      correct: 0
    },
    {
      question: "Ano ang bantas na ginagamit sa dulo ng tanong?",
      options: ["Tuldok", "Kuwit", "Tandang Pananong", "Tandang Padamdam"],
      correct: 2
    },
    {
      question: "Ano ang salitang ginagamit para sa 'nang' sa nakaraang panahon?",
      options: ["Ng", "Nang", "Sa", "Kay"],
      correct: 1
    },
    {
      question: "Ano ang bahagi ng pananalita na naglalarawan?",
      options: ["Pangngalan", "Pang-uri", "Pandiwang", "Pang-abay"],
      correct: 1
    },
    {
      question: "Ano ang tamang ayos: 'Siya ay kumain ng mansanas.'",
      options: ["Mali", "Tama", "Hindi sigurado", "Kailangan ng bantas"],
      correct: 1
    }
  ],
  medium: [
    {
      question: "Ano ang uri ng pangungusap na 'Kumain ka na ba?'",
      options: ["Paliwanag", "Padamdam", "Pananong", "Utos"],
      correct: 2
    },
    {
      question: "Ano ang salitang dapat gamitin: 'Siya ___ kumain ng kanin.'",
      options: ["Ay", "Ang", "Si", "Kay"],
      correct: 0
    },
    {
      question: "Ano ang kahulugan ng salitang 'matipid'?",
      options: ["Prangka", "Mapagbigay", "Maingat sa pera", "Masiyahin"],
      correct: 2
    }
  ],
  hard: [
    {
      question: "Ano ang tawag sa salitang may dalawang kahulugan?",
      options: ["Salitang malabo", "Salitang may dalawang salita", "Salitang may dalawang kahulugan", "Salitang banyaga"],
      correct: 2
    },
    {
      question: "Ano ang salitang dapat gamitin: '___ mga bata ay naglalaro.'",
      options: ["Si", "Kay", "Ang", "Sa"],
      correct: 2
    }
  ]
};

// Monitor auth state
onAuthStateChanged(auth, (user) => {
  console.log('Auth state changed:', user ? 'logged in' : 'logged out');
  
  if (!user) {
    // Not authenticated, redirect to login
    console.log('Not authenticated, redirecting to login');
    window.location.href = '../../public/index.html';
    return;
  }
  
  currentUser = user;
  isAuthenticated = true;

  // Show content when authenticated
  document.getElementById('loading-message').style.display = 'none';
  document.getElementById('main-content').style.display = 'block';
  
  // Load questions
  loadQuestions();
  
  // Add event listeners for difficulty tabs
  setupDifficultyTabs();
  
  // Setup save button listener
  setupSaveButton();
});

// Setup difficulty tab event listeners
function setupDifficultyTabs() {
  document.querySelectorAll('.difficulty-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      const difficulty = tab.getAttribute('data-difficulty');
      switchDifficulty(difficulty);
    });
  });
}

// Attach save button listener to avoid relying on inline onclick in module script
function setupSaveButton() {
  const saveBtn = document.getElementById('save-btn');
  if (!saveBtn) return;
  // Remove any existing listener to avoid duplicates
  saveBtn.replaceWith(saveBtn.cloneNode(true));
  const newSaveBtn = document.getElementById('save-btn') || document.querySelector('.save-btn');
  if (newSaveBtn) newSaveBtn.addEventListener('click', saveQuestions);
}

// Switch difficulty
function switchDifficulty(difficulty) {
  currentDifficulty = difficulty;

  // Update tab styles
  document.querySelectorAll('.difficulty-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('active');

  renderQuestions();
}

// Load questions from Firebase
async function loadQuestions() {
  try {
    showStatus('Loading questions...', 'info');

    if (isAuthenticated && currentUser) {
      const questionsRef = collection(db, 'game_content');

      // Get all documents and filter for speed challenge type
      const allDocs = await getDocs(questionsRef);
      const speedChallengeDocs = [];
      allDocs.forEach(doc => {
        const data = doc.data();
        if (data.gameType === 'speed_challenge') {
          speedChallengeDocs.push({ id: doc.id, data: data });
        }
      });

      if (speedChallengeDocs.length > 0) {
        // Sort by updatedAt and get the most recent
        const sortedDocs = speedChallengeDocs.sort((a, b) => {
          const aTime = a.data.updatedAt?.toDate?.() || new Date(a.data.updatedAt || 0);
          const bTime = b.data.updatedAt?.toDate?.() || new Date(b.data.updatedAt || 0);
          return bTime - aTime;
        });

        const latestDoc = sortedDocs[0];
        questionsData = latestDoc.data.content?.questionsData || JSON.parse(JSON.stringify(defaultQuestions));
        console.log('Loaded latest speed challenge questions from:', latestDoc.id);
        showStatus('Questions loaded from Firebase!', 'success');
      } else {
        // Try localStorage fallback
        const localData = localStorage.getItem('speed_challenge_questions');
        if (localData) {
          questionsData = JSON.parse(localData);
          showStatus('Questions loaded from local storage', 'success');
        } else {
          questionsData = JSON.parse(JSON.stringify(defaultQuestions));
          showStatus('Using default questions', 'info');
        }
      }
    } else {
      // Not authenticated, try localStorage
      const localData = localStorage.getItem('speed_challenge_questions');
      if (localData) {
        questionsData = JSON.parse(localData);
        showStatus('Questions loaded from local storage (offline mode)', 'success');
      } else {
        questionsData = JSON.parse(JSON.stringify(defaultQuestions));
        showStatus('Using default questions (offline mode)', 'info');
      }
    }

    renderQuestions();
    hideStatus();
  } catch (error) {
    console.error('Error loading questions:', error);
    showStatus('Error loading questions, using defaults', 'error');
    
    // Fallback to localStorage
    const localData = localStorage.getItem('speed_challenge_questions');
    if (localData) {
      try {
        questionsData = JSON.parse(localData);
        showStatus('Questions loaded from local storage', 'success');
      } catch (parseError) {
        console.error('Error parsing local storage data:', parseError);
        questionsData = JSON.parse(JSON.stringify(defaultQuestions));
      }
    } else {
      questionsData = JSON.parse(JSON.stringify(defaultQuestions));
    }
    
    renderQuestions();
  }
}

// Render questions for current difficulty
function renderQuestions() {
  const container = document.getElementById('questions-list');
  const questions = questionsData[currentDifficulty] || [];

  // Update statistics
  updateStatistics();

  container.innerHTML = '';

  if (questions.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Walang tanong pa sa difficulty na ito. Magdagdag ng tanong!</p>';
    return;
  }

  questions.forEach((question, index) => {
    const questionElement = createQuestionElement(question, index);
    container.appendChild(questionElement);
  });
}

// Create question element
function createQuestionElement(question, index) {
  const questionDiv = document.createElement('div');
  questionDiv.className = 'question-item';

  questionDiv.innerHTML = `
    <div class="question-header">
      <div class="question-number">Tanong ${index + 1}</div>
    </div>

    <input type="text" class="question-input" placeholder="Ilagay ang tanong..." value="${question.question || ''}" onchange="updateQuestion(${index}, 'question', this.value)">

    <div class="options-container">
      ${(question.options || ['Opsiyon 1', 'Opsiyon 2', 'Opsiyon 3', 'Opsiyon 4']).map((option, optIndex) => `
        <div class="option-item ${question.correct === optIndex ? 'correct-option' : ''}">
          <input type="radio" name="correct-${index}" value="${optIndex}" ${question.correct === optIndex ? 'checked' : ''} onchange="updateCorrect(${index}, ${optIndex})" class="correct-radio">
          <input type="text" class="option-input" placeholder="Ilagay ang opsiyon..." value="${option}" onchange="updateOption(${index}, ${optIndex}, this.value)">
          <span class="option-label">${String.fromCharCode(65 + optIndex)}</span>
          ${question.options.length > 2 ? `<button class="action-btn delete-option-btn" onclick="deleteOption(${index}, ${optIndex})">√ó</button>` : ''}
        </div>
      `).join('')}
    </div>

    <div class="question-actions">
      <button class="action-btn add-option-btn" onclick="addOption(${index})">+ Opsiyon</button>
      <button class="action-btn duplicate-btn" onclick="duplicateQuestion(${index})" style="background: #ffc107; color: #000;">üìã Duplicate</button>
      <button class="action-btn delete-question-btn" onclick="deleteQuestion(${index})">üóëÔ∏è Tanggalin</button>
    </div>
  `;

  return questionDiv;
}

// Add new question
function addQuestion() {
  const newQuestion = {
    question: 'Bagong tanong',
    options: ['Opsiyon 1', 'Opsiyon 2', 'Opsiyon 3', 'Opsiyon 4'],
    correct: 0
  };

  if (!questionsData[currentDifficulty]) {
    questionsData[currentDifficulty] = [];
  }

  questionsData[currentDifficulty].push(newQuestion);
  renderQuestions();
}

// Update question field
function updateQuestion(index, field, value) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][index]) {
    questionsData[currentDifficulty][index][field] = value;
  }
}

// Update option
function updateOption(questionIndex, optionIndex, value) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][questionIndex]) {
    if (!questionsData[currentDifficulty][questionIndex].options) {
      questionsData[currentDifficulty][questionIndex].options = [];
    }
    questionsData[currentDifficulty][questionIndex].options[optionIndex] = value;
  }
}

// Update correct answer
function updateCorrect(questionIndex, correctIndex) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][questionIndex]) {
    questionsData[currentDifficulty][questionIndex].correct = correctIndex;
  }
}

// Add option to question
function addOption(questionIndex) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][questionIndex]) {
    if (!questionsData[currentDifficulty][questionIndex].options) {
      questionsData[currentDifficulty][questionIndex].options = [];
    }
    questionsData[currentDifficulty][questionIndex].options.push('Bagong opsiyon');
    renderQuestions();
  }
}

// Delete option
function deleteOption(questionIndex, optionIndex) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][questionIndex]) {
    if (questionsData[currentDifficulty][questionIndex].options.length > 2) {
      questionsData[currentDifficulty][questionIndex].options.splice(optionIndex, 1);
      // Adjust correct answer if needed
      if (questionsData[currentDifficulty][questionIndex].correct >= optionIndex) {
        questionsData[currentDifficulty][questionIndex].correct = Math.max(0, questionsData[currentDifficulty][questionIndex].correct - 1);
      }
      renderQuestions();
    }
  }
}

// Delete question
function deleteQuestion(index) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][index]) {
    if (confirm('Sigurado ka bang tanggalin ang tanong na ito?')) {
      questionsData[currentDifficulty].splice(index, 1);
      renderQuestions();
      showStatus('Question deleted!', 'info');
    }
  }
}

// Duplicate question
function duplicateQuestion(index) {
  if (questionsData[currentDifficulty] && questionsData[currentDifficulty][index]) {
    const questionToDuplicate = JSON.parse(JSON.stringify(questionsData[currentDifficulty][index]));
    questionsData[currentDifficulty].splice(index + 1, 0, questionToDuplicate);
    renderQuestions();
    showStatus('Question duplicated!', 'success');
  }
}

// Update statistics display
function updateStatistics() {
  const easyCount = questionsData.easy ? questionsData.easy.length : 0;
  const mediumCount = questionsData.medium ? questionsData.medium.length : 0;
  const hardCount = questionsData.hard ? questionsData.hard.length : 0;
  const totalCount = easyCount + mediumCount + hardCount;

  document.getElementById('easy-count').textContent = easyCount;
  document.getElementById('medium-count').textContent = mediumCount;
  document.getElementById('hard-count').textContent = hardCount;
  document.getElementById('total-count').textContent = totalCount;
}

// Validate questions before saving
function validateQuestions() {
  const errors = [];

  Object.keys(questionsData).forEach(difficulty => {
    const questions = questionsData[difficulty] || [];
    questions.forEach((question, index) => {
      if (!question.question || question.question.trim() === '') {
        errors.push(`${difficulty} - Question ${index + 1}: Missing question text`);
      }

      if (!question.options || question.options.length < 2) {
        errors.push(`${difficulty} - Question ${index + 1}: Need at least 2 options`);
      } else {
        question.options.forEach((option, optIndex) => {
          if (!option || option.trim() === '') {
            errors.push(`${difficulty} - Question ${index + 1}: Option ${String.fromCharCode(65 + optIndex)} is empty`);
          }
        });
      }

      if (question.correct === undefined || question.correct === null || question.correct >= question.options.length) {
        errors.push(`${difficulty} - Question ${index + 1}: Invalid correct answer`);
      }
    });
  });

  return errors;
}

// Save questions to Firebase
async function saveQuestions() {
  // Validate questions first
  const validationErrors = validateQuestions();
  if (validationErrors.length > 0) {
    const errorMessage = 'Please fix the following errors:\n\n' + validationErrors.join('\n');
    alert(errorMessage);
    showStatus('Validation failed. Please check your questions.', 'error');
    return;
  }

  const saveBtn = document.getElementById('save-btn');
  const originalText = saveBtn.innerHTML;
  saveBtn.disabled = true;
  saveBtn.innerHTML = 'Saving... <div class="loading"></div>';

  try {
    showStatus('Saving questions...', 'info');

    if (isAuthenticated && currentUser) {
      const contentData = {
        gameType: 'speed_challenge',
        teacherId: currentUser.uid,
        content: { questionsData: questionsData },
        updatedAt: new Date(),
        createdAt: new Date()
      };

      console.log('Saving contentData:', contentData);

      const docId = `speed_challenge`;
      const docRef = doc(db, 'game_content', docId);

      await setDoc(docRef, contentData);
      console.log('Successfully saved to Firebase');

      showStatus('Questions saved successfully!', 'success');
    } else {
      // Save to localStorage as fallback
      localStorage.setItem('speed_challenge_questions', JSON.stringify(questionsData));
      showStatus('Questions saved to local storage (offline mode)', 'success');
    }

    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;

  } catch (error) {
    console.error('Error saving questions:', error);
    // Fallback to localStorage
    localStorage.setItem('speed_challenge_questions', JSON.stringify(questionsData));
    showStatus('Questions saved to local storage due to error', 'warning');
    saveBtn.innerHTML = originalText;
    saveBtn.disabled = false;
  }
}

// Status message functions
function showStatus(message, type) {
  hideStatus();
  const statusDiv = document.createElement('div');
  statusDiv.className = `status-message status-${type}`;
  statusDiv.textContent = message;
  document.body.appendChild(statusDiv);

  setTimeout(() => {
    hideStatus();
  }, 3000);
}

function hideStatus() {
  const existing = document.querySelector('.status-message');
  if (existing) {
    existing.remove();
  }
}

// Reset to default questions
function resetToDefaults() {
  if (confirm('This will reset all questions to the default set. All your changes will be lost. Are you sure?')) {
    questionsData = JSON.parse(JSON.stringify(defaultQuestions));
    renderQuestions();
    showStatus('Questions reset to defaults!', 'info');
  }
}

// Clear all questions
function clearAllQuestions() {
  if (confirm('This will delete ALL questions in the current difficulty. Are you sure?')) {
    questionsData[currentDifficulty] = [];
    renderQuestions();
    showStatus('All questions cleared!', 'warning');
  }
}
window.addQuestion = addQuestion;
window.updateQuestion = updateQuestion;
window.updateOption = updateOption;
window.updateCorrect = updateCorrect;
window.addOption = addOption;
window.deleteOption = deleteOption;
window.deleteQuestion = deleteQuestion;
window.saveQuestions = saveQuestions;
window.duplicateQuestion = duplicateQuestion;
window.resetToDefaults = resetToDefaults;
window.clearAllQuestions = clearAllQuestions;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Firebase auth will handle loading
});
</script>
</body>
</html>